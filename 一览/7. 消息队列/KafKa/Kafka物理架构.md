Kafka的物理架构如下：

![](https://pcc.huitogo.club/z0/ac883ce247c1ff31c7cd4244392dcaed)



主要组件说明和特性如下：

#### 1. producer（生产者）

producer主要是用于生产消息，是kafka当中的消息生产者，生产的消息通过topic进行归类，保存到kafka的broker里面去。



#### 2.topic（主题）

1. kafka将消息以topic为单位进行归类；
2. topic特指kafka处理的消息源（feeds of messages）的不同分类；
3. topic是一种分类或者发布的一些列记录的名义上的名字。kafka主题始终是支持多用户订阅的；也就是说，一 个主题可以有零个，一个或者多个消费者订阅写入的数据；
4. 在kafka集群中，可以有无数的主题；
5. 生产者和消费者消费数据一般以主题为单位。更细粒度可以到分区级别。



#### 3. partition（分区）

kafka当中，topic是消息的归类，一个topic可以有多个分区（partition），每个分区保存部分topic的数据，所有的partition当中的数据全部合并起来，就是一个topic当中的所有的数据。

在kafka中，每一个分区会有一个编号：编号从0开始。

**每一个分区内的数据是有序的，但全局的数据不能保证是有序的。**（有序是指生产什么样顺序，消费时也是什么样的顺序）



#### 4. consumer（消费者）

consumer是kafka当中的消费者，主要用于消费kafka当中的数据，消费者一定是归属于某个消费组中的。



#### 5. consumer group（消费者组）

消费者组由一个或者多个消费者组成，**同一个组中的消费者对于同一条消息只消费一次。**

每个消费者都属于某个消费者组，如果不指定，那么所有的消费者都属于默认的组。

每个消费者组都有一个ID，即group ID。组内的所有消费者协调在一起来消费一个订阅主题( topic)的所有分区(partition)。当然，**每个分区只能由同一个消费组内的一个消费者(consumer)来消费**，可以由不同的消费组来消费。



**partition数量决定了每个consumer group中并发消费者的最大数量。**如下图：

![](https://pcc.huitogo.club/kafka1.png)



如上面左图所示，如果只有两个分区，即使一个组内的消费者有4个，也会有两个空闲的。

如上面右图所示，有4个分区，每个消费者消费一个分区，并发量达到最大4。



总结下kafka中分区与消费组的关系：

消费组： 由一个或者多个消费者组成，同一个组中的消费者对于同一条消息只消费一次。 **某一个主题下的分区数，对于消费该主题的同一个消费组下的消费者数量，应该小于等于该主题下的分区数。**



如：某一个主题有4个分区，那么消费组中的消费者应该小于等于4，而且最好与分区数成整数倍 1 2 4 这样。**同一个分区下的数据，在同一时刻，不能同一个消费组的不同消费者消费**。



总结：**分区数越多，同一时间可以有越多的消费者来进行消费，消费数据的速度就会越快，提高消费的性能。**



#### 6. partition replicas（分区副本）

![](https://pcc.huitogo.club/kafka2.png)



**副本数（replication-factor）**：控制消息保存在几个broker（服务器）上，**一般情况下副本数等于broker的个数。**

> 一个broker服务下，不可以创建多个副本因子。创建主题时，副本因子应该小于等于可用的broker数。
>



副本因子操作以分区为单位的。每个分区都有各自的主副本和从副本；

主副本叫做leader，从副本叫做 follower（在有多个副本的情况下，kafka会为同一个分区下的所有分区，设定角色关系：一个leader和N个 follower），**处于同步状态的副本叫做in-sync-replicas(ISR)**;

**follower通过拉的方式从leader同步数据**。 **消费者和生产者只从leader读写数据**，不与follower交互。、

> 注：在RocketMQ中，Topic也会分布在多个Broker中，也有主节点和从节点，和Kafka不同，RocketMQ的从节点会提供读负载。



副本因子的作用：**让kafka读取数据和写入数据时的可靠性**。

如果某一个分区有三个副本因子，就算其中一个挂掉，那么只会在剩下的两个中，选择一个leader，但**不会在其他的broker中，另启动一个副本**（因为在另一台启动的话，存在数据传递，只要在机器之间有数据传递，就会长时间占用网络IO，kafka是一个高吞吐量的消息系统，这个情况不允许发生）所以不会在另一个broker中启动。

如果所有的副本都挂了，生产者如果生产数据到指定分区的话，将写入不成功。







