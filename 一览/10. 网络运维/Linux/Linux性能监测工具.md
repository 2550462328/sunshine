Linux系统分析工具总结

![img](http://pcc.huitogo.club/197d4e20463d2041d30f80b57b419e3d)



接下来我们从CPU、内存、磁盘和网络去分析当前操作系统



#### 1. CPU

对于进程，我们关注内核CPU调度器功能和性能。

对于线程，我们关注线程的时间用在什么地方。（线程是进程的组成单位，主要是分析线程）



线程状态大体分为：

- on-CPU：执行中，执行中的时间通常又分为用户态时间user和系统态时间sys。
- off-CPU：等待下一轮上CPU，或者等待I/O、锁、换页等等，其状态可以细分为可执行、 匿名换页、睡 眠、锁、空闲等状态。



主要工具有

![img](http://pcc.huitogo.club/1d5e5086c5d97a732fbc501cab345db7)



##### 1.1 uptime/w

![img](http://pcc.huitogo.club/40c1c58afccf16127a1b23b99ea5539c)



第一项是当前时间，up 表示系统正在运行，136days+20min是系统启动的总时间，最后是系统的负载load信息

w 同上，增加了具体登陆了那些用户及登陆时间。



##### 1.2 top

![img](http://pcc.huitogo.club/c09c0db5b61e6b233e87d1c29fa9c396)



1）第一行显示系统**运行时间和平均负载**，和uptime类似

2）第二行显示的是**任务**或者进程的总结。进程可以处于不同的状态。这里显示了全部进程的数量。除此之外，还有正在运行、睡眠、停止、僵尸进程的数量（僵尸是一种进程的状态）。这些进程概括信息可以用’t’切换显示。

3）第三行显示的是**CPU状态**。 这里显示了不同模式下的所占CPU时间的百分比。这些不同的CPU时间表示:

- us, user： 运行(未调整优先级的) 用户进程的CPU时间
- sy，system: 运行内核进程的CPU时间
- ni，niced：运行已调整优先级的用户进程的CPU时间
- wa，IO wait: 用于等待IO完成的CPU时间
- hi：处理硬件中断的CPU时间
- si: 处理软件中断的CPU时间
- st：这个虚拟机被hypervisor偷去的CPU时间（译注：如果当前处于一个hypervisor下 的vm，实际上hypervisor也是要消耗一部分CPU处理时间的）。



4）第四行和第五行显示**内存使用率**，类似“free”命令。第四行是物理内存使用，第五行是虚拟内存使用(交换空间)

物理内存显示如下:全部可用内存、已使用内存、空闲内存、缓冲内存。相似地：交换部分显示的是：全部、已使用、空闲和缓冲交换空间。



这里要说明的是不能用windows的内存概念理解这些数据，如果按windows的方式此台服务器“危矣”：8G的内存总量只剩下530M的可用内存。Linux的内存管理有其特殊性，复杂点需要一本书来说明，这里只是简单说点和我们传统概念（windows）的不同。

第四行中使用中的内存总量（used）指的是现在系统内核控制的内存数，空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到free中去，因此在[linux](http://lib.csdn.net/base/linux)上free内存会越来越少，但不用为此担心。



如果出于习惯去计算可用内存数，这里有个近似的计算公式：

**第四行的free + 第四行的buffers + 第五行的cached**。



对于内存监控，在top里我们要时刻监控第五行swap交换分区的used，如果这个数值在不断的变化，说明内核在不断进行内存和swap的数据交换，这是真正的内存不够用了。



5）最后的一个列表展示的就是详细的进程占用的资源情况

字段解释如下：

![img](http://pcc.huitogo.club/14fb078d8e598cfb8309b5225e43be76)



对于top的常用交互方式

- ‘B’：一些重要信息会以加粗字体显示(高亮)。这个命令可以切换粗体显示。
- ‘D’或’S‘: 你将被提示输入一个值（以秒为单位），它会以设置的值作为刷新间隔。如果你这里输入了1，top将会每秒刷新。 top默认为3秒刷新
- ‘l’、‘t’、‘m’: 切换负载、任务、内存信息的显示，这会相应地切换顶部的平均负载、任务/CPU状态和内存信息的概况显示。
- ‘z’ : 切换彩色显示
- ‘x’ 或者 ‘y’
- 切换高亮信息：’x’将排序字段高亮显示（纵列）；’y’将运行进程高亮显示（横行）。依赖于你的显示设置，你可能需要让输出彩色来看到这些高亮。
- ‘u’: 特定用户的进程
- ‘n’ 或 ‘#’: 任务的数量
- ‘k’: 结束任务



关于top的一些常用参数

- top //每隔3秒显式所有进程的资源占用情况
- top -u oracle -c //按照用户显示进程、并显示完整命令
- top -d 2 //每隔2秒显式所有进程的资源占用情况
- top -c //每隔3秒显式进程的资源占用情况，并显示进程的命令行参数(默认只有进程名)
- top -p 12345 -p 6789//每隔3秒显示pid是12345和pid是6789的两个进程的资源占用情况
- top -d 2 -c -p 123456 //每隔2秒显示pid是12345的进程的资源使用情况，并显式该进程启动的命令行参数
- top -n 设置显示多少次后就退出
- top -Hp 12345 //每隔3秒显示pid是12345进程下的线程资源占用情况



##### 1.3 vmstat

vmstat命令是最常见的Linux/Unix监控工具，可以展现给定时间间隔的服务器的状态值,包括服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况。



使用格式vmstat 采样时间间隔（秒） 采样次数

![img](http://pcc.huitogo.club/056a0354ee36f24d4b195d195add0897)



每个参数含义

1）procs：进程

- r表示运行队列中进程数量，这个值也可以判断是否需要增加CPU。（长期大于1）；
- b表示等待IO的进程数量。



2）memory：内存

- swpd：使用虚拟内存大小，如果swpd的值不为0，但是SI，SO的值长期为0，这种情 况不会影响系统性能。
- free：空闲物理内存大小。
- buff：用作缓冲的内存大小。
- cache：用作缓存的内存大小，如果cache的值大的时候，说明cache处的文件数多，如 果频繁访问到的文件都能被cache处，那么磁盘的读IO bi会非常小。



3）swap：交换区

- si：每秒从交换区写到内存的大小，由磁盘调入内存。
- so：每秒写入交换区的内存大小，由内存调入磁盘。

注意：内存够用的时候，这2个值都是0，如果这2个值长期大于0时，系统性能会受到影响，磁盘IO和CPU资源都会被消耗。有些朋友看到空闲内存（free）很少的或接近于0时，就认为内存不够用了，不能光看这一点，还要结合si和so，如果free很少，但是si和so也很少（大多时候是0），那么不用担心，系统性能这时不会受到影响的。因为linux总是先把内存用光.



4）io

- bi：每秒读取的块数
- bo：每秒写入的块数

注意：随机磁盘读写的时候，这2个值越大（如超出1024k)，能看到CPU在IO等待的值也会越大。



5）system：系统

- in：每秒中断数，包括时钟中断。
- cs：每秒上下文切换数。

注意：上面2个值越大，会看到由内核消耗的CPU时间会越大。



6）cpu

- us：用户进程执行时间百分比(user time) us的值比较高时，说明用户进程消耗的CPU时间多，但是如果长期超50%的使用，那么我们就该考虑优化程序算法或者进行加速。
- sy：内核系统进程执行时间百分比(system time) sy的值高时，说明系统内核消耗的CPU资源多，这并不是良性表现，我们应该检查原因。
- wa：IO等待时间百分比 wa的值高时，说明IO等待比较严重，这可能由于磁盘大量作随机访问造成，也有可能磁盘出现瓶颈（块操作）。
- id：空闲时间百分比



##### 1.4 mpstat

mpstat是一个实时监控工具，主要报告与CPU相关统计信息,在多核心cpu系统中，不仅可以查看cpu平均信息，还可以查看指定cpu信息。



常用使用

- mpstat -P ALL //查看全部CPU的负载情况。

- mpstat 2 5 //可指定间隔时间和次数。

![img](http://pcc.huitogo.club/edcf5fc325d4d39cdeb042fadef54916)



输出字段说明：

![img](http://pcc.huitogo.club/1ec8197fe21e72a1787cd7a64983d773)



##### 1.5 sar

系统活动情况报告，可以从多方面对系统的活动进行报告，包括：文件的读写情况、系统调用的使用情况、磁盘I/O、CPU效率、内存使用状况、进程活动及IPC有关的活动等。



sar查看CPU

- sar -p （查看全天）
- sar -u 1 10 （1：每隔一秒，10：写入10次）

![img](http://pcc.huitogo.club/03e12d4741ac952cd33c92beadc34fcb)



输出字段说明：

- CPU:all 表示统计信息为所有 CPU 的平均值。
- %user:显示在用户级别(application)运行使用 CPU 总时间的百分比。
- %nice:显示在用户级别，用于nice操作，所占用 CPU 总时间的百分比。
- %system:在核心级别(kernel)运行所使用 CPU 总时间的百分比。
- %iowait:显示用于等待I/O操作占用 CPU 总时间的百分比。
- %steal:管理程序(hypervisor)为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。
- %idle:显示 CPU 空闲时间占用 CPU 总时间的百分比。



##### 1.6 pidstat

用于监控全部或指定进程的cpu、内存、线程、设备IO等系统资源的占用情况。

pidstat 和 pidstat -u -p ALL 是等效的。 pidstat 默认显示了所有进程的cpu使用率。

![img](http://pcc.huitogo.club/9635dec780361d105f36e55be4a3a036)



输出字段说明

- PID：进程ID
- %usr：进程在用户空间占用cpu的百分比
- %system：进程在内核空间占用cpu的百分比
- %guest：进程在虚拟机占用cpu的百分比
- %CPU：进程占用cpu的百分比
- CPU：处理进程的cpu编号
- Command：当前进程对应的命令



#### 2. 内存

内存是为提高效率而生，实际分析问题的时候，内存出现问题可能不只是影响性能，而是影响服务或者引起其他问题。



关于内存分析我们需要了解的一些词汇

- 主存
- 虚拟内存
- 常驻内存：一种辅助程序，能假装退出，而仍驻留于内存当中，让你运行其它的应用。
- 地址空间：包括物理空间以及[虚拟空间](https://baike.baidu.com/item/虚拟空间/99513)。
- OOM
- 页缓存
- 缺页
- 换页
- 交换空间
- 交换
- 用户分配器libc、glibc、libmalloc和mtmalloc
- LINUX内核级SLUB分配器



内存分析方式总结如下：

![img](http://pcc.huitogo.club/7ce120be19ae5a3334d8aee1eba46966)



##### 2.1 free

free 命令显示系统内存的使用情况，包括物理内存、交换内存(swap)和内核缓冲区内存。

![img](http://pcc.huitogo.club/c26b22085993b70fecbd71a40d544b44)



第一行是内存的使用情况；第二行是交换空间的使用情况。

- total 列显示系统总的可用物理内存和交换空间大小。
- used 列显示已经被使用的物理内存和交换空间。
- free 列显示还有多少物理内存和交换空间可用使用。
- shared 列显示被共享使用的物理内存大小。
- buff/cache 列显示被 buffer 和 cache 使用的物理内存大小。
- available 列显示还可以被应用程序使用的物理内存大小。



关于free的常用使用指令

- free
- free -g 以GB显示
- free -m 以MB显示
- free -h 自动转换展示
- free -h -s 3 有时我们需要持续的观察内存的状况，此时可以使用 -s 选项并指定间隔的 秒数



从应用程序的角度来说，available = free + buffer + cache



##### 2.2 top

参考CPU



##### 2.3 vmstat

参考CPU



##### 2.4 sar

使用sar分析内存的指令 sar -r

![img](http://pcc.huitogo.club/5c41d4517347e78c999c83188f224f9c)



输出字段说明

- kbmemfree 空闲的物理内存大小
- kbmemused 使用中的物理内存大小
- %memused 物理内存使用率
- kbbuffers 内核中作为缓冲区使用的物理内存大小，kbbuffers和kbcached:这两个值就是 free命令中的buffer 和cache.
- kbcached 缓存的文件大小
- kbcommit 保证当前系统正常运行所需要的最小内存，即为了确保内存不溢出而需要的 最少内存（物理内存 +Swap分区）
- commt 这个值是kbcommit与内存总量（物理内存+swap分区）的一个百分比的值



##### 2.5 pidstat

使用pidstat分析内存的指令 pidstat -r

![img](http://pcc.huitogo.club/7828bd9a0d3645d09fb354a3de9d46fe)



输出字段说明如下：

- PID：进程标识符
- Minflt/s:任务每秒发生的次要错误，不需要从磁盘中加载页
- Majflt/s:任务每秒发生的主要错误，需要从磁盘中加载页
- VSZ：虚拟地址大小，虚拟内存的使用KB
- RSS：常驻集合大小，非交换区五里内存使用KB
- Command：task命令名



#### 3. 磁盘IO

磁盘通常是计算机最慢的子系统，也是最容易出现性能瓶颈的地方，因为磁盘离 CPU 距离最远而且 CPU 访问磁盘要涉及到机械操作，比如转轴、寻轨等。访问硬盘和访问内存之间的速度差别是以数量级来计算的，就像1天和1分钟的差别一样。要监测 IO 性能，有必要了解一下基本原理和 Linux 是如何处理硬盘和内存之间的 IO 的。



关于磁盘IO分析也有一些专有词汇

- 文件系统
- VFS：虚拟文件系统，Linux文件系统对外的接口。任何要使用文件系统的程序都必须经由这层接口来使用它
- 文件系统缓存
- 页缓存page cache
- 缓冲区高速缓存buffer cache
- 目录缓存
- inode
- inode缓存
- noop调用策略



分析工具总结如下：

![img](http://pcc.huitogo.club/61a45d16afe97affcde0b4a4e7185d77)



##### 3.1 iostat

iostat工具将对系统的磁盘操作活动进行监视。它的特点是汇报磁盘活动统计情况，同时也会汇报出CPU使用情况

![img](http://pcc.huitogo.club/d05f11db481cea41786625369c6de451)



1）CPU属性

- %user：CPU处在用户模式下的时间百分比。
- %nice：CPU处在带NICE值的用户模式下的时间百分比。
- %system：CPU处在系统模式下的时间百分比。
- %iowait：CPU等待输入输出完成时间的百分比。
- %steal：管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比。
- %idle：CPU空闲时间百分比。



2）Device属性

- tps：该设备每秒的传输次数
- kB_read/s：每秒从设备（drive expressed）读取的数据量；
- kB_wrtn/s：每秒向设备（drive expressed）写入的数据量；
- kB_read： 读取的总数据量；
- kB_wrtn：写入的总数量数据量



关于iostat的常用指令

- iostat 2 3 每隔2秒刷新显示，且显示3次
- iostat -m 以M为单位显示所有信息
- iostat -d -x -k 1 1 查看设备使用率（%util）、响应时间（await）



##### 3.2 pidstat

显示各个进程的IO使用情况，使用格式pidstat -d

![img](http://pcc.huitogo.club/3c71736aea142dca6048480a6e3032ae)



输出字段说明：

- PID：进程id
- kB_rd/s：每秒从磁盘读取的KB
- kB_wr/s：每秒写入磁盘KB
- kB_ccwr/s：任务取消的写入磁盘的KB。当任务截断脏的pagecache的时候会发生。
- COMMAND:task的命令名



#### 4. 网络

分析工具总结如下：

![img](http://pcc.huitogo.club/1834479d228fb9e270687b34dea1f59a)



##### 4.1 ping

关于ping常用的命令参数

- -d 使用Socket的SO_DEBUG功能。
- -f 极限检测。大量且快速地送网络封包给一台机器，看它的回应。
- -n 只输出数值。
- -q 不显示任何传送封包的信息，只显示最后的结果。
- -r 忽略普通的Routing Table，直接将数据包送到远端主机上。通常是查看本机的网络接 口是否有问题。
- -R 记录路由过程。
- -v 详细显示指令的执行过程。
- -c 数目：在发送指定数目的包后停止。
- -i 秒数：设定间隔几秒送一个网络封包给一台机器，预设值是一秒送一次。
- -I 网络界面：使用指定的网络界面送出数据包。
- -l 前置载入：设置在送出要求信息之前，先行发出的数据包。
- -p 范本样式：设置填满数据包的范本样式。
- -s 字节数：指定发送的数据字节数，预设值是56，加上8字节的ICMP头，一共是64ICMP 数据字节。
- -t 存活数值：设置存活数值TTL的大小。



##### 4.2 netstat

netstat命令是一个监控TCP/IP网络的非常有用的工具，它可以显示路由表、实际的网络连接以及每一个网络接口设备的状态信息。



关于netstat的使用选项

- -a或--all：显示所有连线中的Socket；
- -a (all) 显示所有选项，默认不显示LISTEN相关。
- -t (tcp) 仅显示tcp相关选项。
- -u (udp) 仅显示udp相关选项。
- -n 拒绝显示别名，能显示数字的全部转化成数字。
- -l 仅列出有在 Listen (监听) 的服务状态。
- -p 显示建立相关链接的程序名
- -r 显示路由信息，路由表
- -e 显示扩展信息，例如uid等
- -s 按各个协议进行统计
- -c 每隔一个固定时间，执行该netstat命令。



常用的比如查看8080端口占用情况：netstat -tunlp | grep 8080