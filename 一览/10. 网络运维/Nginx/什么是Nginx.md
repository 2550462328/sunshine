#### 1. Nginx 特点

1. 处理响应请求快（异步非阻塞I/O，零拷贝，mmap，缓存机制）
2. 扩展性好（模块化设计）
3. 内存消耗低（异步非阻塞，多阶段处理）
4. 具有很高的可靠性（无数次的生产验证，很多头部公司都在用）
5. 热部署
6. 高并发连接（事件驱动模型，多进程机制）
7. 自由的BSD许可协议（可以自己修改代码后发布，包容性极强）



#### 2. Nginx 架构

![](https://pcc.huitogo.club/nginx1.png)



nginx的架构特点

##### 2.1 事件驱动&异步非阻塞

本质来说，「**事件驱动是一种思想（事实上它不仅仅局限于编程）**」 ，事件驱动思想是实现 「**异步非阻塞特性**」 的一个重要手段。

对于web服务器来说，造成性能拉胯不支持高并发的常见原因就是由于使用了传统的I/O模型造成**在内核没有可读/可写事件（或者说没有数据可供用户进程读写）时，「用户线程」 一直在等待**（其他事情啥也干不了就是干等等待内核上的数据可读/可写），这样的话其实是一个线程（ps:线程在Linux系统也是进程）对应一个请求，请求是无限的，而线程是有限的从而也就形成了并发瓶颈。

而大佬们为了解决此类问题，运用了事件驱动思想来对传统I/O模型做个改造，即在客户端发起请求后，用户线程**不再阻塞等待内核数据就绪，而是立即返回**（可以去执行其他业务逻辑或者继续处理其他请求）。当内核的I/O操作完成后，**内核系统**会向用户线程**发送一个事件通知**，用户线程才来处理这个读/写操作，之后拿到数据再做些其他业务后响应给客户端，从而完成一次客户端请求的处理。



事件驱动的I/O模型中，程序不必阻塞等待I/O操作的完成，也无需为每个请求创建一个线程，从而提高了系统的并发处理能力和响应速度。**事件驱动型的I/O模型通常也被被称为I/O多路复用**，即这种模型可以在一个线程中，处理多个连接（复用就是指多个连接复用一个线程，多路也即所谓的 多个连接），通过这种方式避免了线程间切换的开销，同时也使得用户线程不再被阻塞，提高了系统的性能和可靠性。

nginx支持事件驱动是因为他利用了操作系统提供的I/O多路复用接口，如Linux系统中，常用的I/O多路复用接口有select/poll，epoll。这些接口可以监视多个文件描述符的状态变化，当文件描述符可读或可写时，就会向用户线程发送一个事件通知。用户线程通过事件处理机制（读取/写入数据）来处理这个事件，之后进行对应的业务逻辑完了进行响应。



简单一句话概括： **事件驱动机制就是指当有读/写/连接事件就绪时 再去做读/写/接受连接这些事情，而不是一直在那里傻傻的等，也正应了他的名词： 【事件驱动！】，基于事件驱动思想设计的多路复用I/O（如select/poll，epoll），相对于传统I/O模型，达到了异步非阻塞的效果！**



##### 2.2 多进程机制

nginx有两种类型的进程，一种是**Master主进程**，一种是**Worker工作进程**。

主进程主要负责3项工作：

1. 加载配置

2. 启动工作进程

3. 非停升级。

   

work进程是主进程启动后，**fork**而来的。假设 Nginx fork了多个(具体在于你的配置)Worker进程，并且在Master进程中通过 socket 套接字监听（listen）80端口。然后每个worker进程都可以去 accept 这个监听的 socket。 当一个连接进来后，所有Worker进程，都会收到消息，但是**只有一个Worker进程可以 accept 这个连接**，其它的则 accept 失败，Nginx 保证只有一个Worker去accept的方式就是加锁（accept_mutex）。有了锁之后，在同一时刻，就只会有一个Worker进程去 accpet 连接，在 Worker 进程拿到 Http 请求后，就开始按照worker进程内的预置模块去处理该 Http 请求，最后返回响应结果并断开连接。

其实如果熟悉reactor模型你会发现，nginx的设计有reactor的影子，只不过reactor的主reactor是会负责accept的，而nginx的主进程（对应主reactor） 是不会去accept的，而是交给了worker进程来处理。



worker进程除了accept连接之外，还会执行：**网络读写、存储读写、内容传输、以及请求分发**等等。而其代码的模块化设计，也使得我们可以根据需要对功能模块 进行适当的选择和修改，编译成符合特定需要/业务的服务器。



##### 2.3 proxy cache（服务端缓存）

proxy cache主要实现 nginx 服务器对客户端数据请求的快速响应。

nginx 服务器在接收到被代理服务器的响应数据之后，一方面将数据传递给客户端，另一方面根据proxy cache的配置将这些数据缓存到本地硬盘上。当客户端再次访问相同的数据时，nginx服务器直接从硬盘检索到相应的数据返回给用户，从而减少与被代理服务器交互的时间。

在缓存数据时，运用了零拷贝以及mmap技术，使得数据copy性能大幅提升。



##### 2.4 反向代理

nginx的强大之处其中一个就是他的反向代理，通过反向代理，可以隐藏真正的服务，增加其安全性，同时便于统一管理处理请求，另外可以很容易的做个负载均衡，更好的面对高并发的场景。



#### 3. **Nginx模块**

nginx服务器由n多个模块组成，**每个模块就是一个功能**，某个模块只负责自身的功能，所以说对于 「“**高内聚，低耦合**“」 的编程规则，在nginx身上可谓体现的淋漓尽致。

![](https://pcc.huitogo.club/nginx2.png)



1. **核心模块** ：是nginx 服务器正常运行必不可少的模块，提供错误日志记录、配置文件解析、事件驱动 机制、进程管理等核心功能
2. **标准HTTP模块** ：提供 HTTP 协议解析相关的功能，如：端口配置、网页编码设置、HTTP 响应头设 置等
3. **可选HTTP模块** ：主要用于扩展标准的 HTTP 功能，让nginx能处理一些特殊的服务，如：Flash 多 媒体传输、解析 GeoIP 请求、SSL 支持等
4. **邮件服务模块** ：主要用于支持 nginx  的邮件服务，包括对 POP3 协议、IMAP 协议和 SMTP 协议的支持
5. **第三方模块**」：是为了扩展 Nginx 服务器应用，完成开发者自定义功能，如：Json 支持、Lua 支持等



#### 4. Nginx使用场景

- 反向代理
- 负载均衡
- 缓存
- 限流
- 黑/白名单
- 静态资源服务
- 动静分离
- 防盗链
- 跨域
- 高可用
- .......



#### 5. Nginx目录

```
[root@localhost /]# tree  /usr/local/nginx/  -L 2
├── conf                        #存放一系列配置文件的目录
│   ├── fastcgi.conf           #fastcgi程序相关配置文件
│   ├── fastcgi.conf.default   #fastcgi程序相关配置文件备份
│   ├── fastcgi_params         #fastcgi程序参数文件
│   ├── fastcgi_params.default #fastcgi程序参数文件备份
│   ├── koi-utf           #编码映射文件
│   ├── koi-win           #编码映射文件
│   ├── mime.types        #媒体类型控制文件
│   ├── mime.types.default#媒体类型控制文件备份
│   ├── nginx.conf        #主配置文件
│   ├── nginx.conf.default#主配置文件备份
│   ├── scgi_params      #scgi程序相关配置文件
│   ├── scgi_params.default #scgi程序相关配置文件备份
│   ├── uwsgi_params       #uwsgi程序相关配置文件
│   ├── uwsgi_params.default#uwsgi程序相关配置文件备份
│   └── win-utf          #编码映射文件
├── html                 #存放网页文档
│   ├── 50x.html         #错误页码显示网页文件
│   └── index.html       #网页的首页文件
├── logs                 #存放nginx的日志文件
├── sbin                #存放启动程序
│   ├── nginx           #nginx启动程序     
```



