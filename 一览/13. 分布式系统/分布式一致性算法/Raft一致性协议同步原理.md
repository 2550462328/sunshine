#### 1. 什么是Raft协议？

分布式系统除了提升整个体统的性能外还有一个重要特征就是提高系统的可靠性。



提供可靠性可以理解为系统中一台或多台的机器故障不会使系统不可用（或者丢失数据）。

保证系统可靠性的关键就是多副本（即数据需要有备份），一旦有多副本，那么久面临多副本之间的一致性问题。



**一致性算法正是用于解决分布式环境下多副本之间数据一致性的问题的。**

业界最著名的一致性算法就是大名鼎鼎的Paxos（Chubby的作者曾说过：世上只有一种一致性算法，就是Paxos）。**但Paxos是出了名的难懂，而Raft正是为了探索一种更易于理解的一致性算法而产生的。**



**Raft是一种管理复制日志的一致性算法**。

它的首要设计目的就是易于理解，所以在选主的冲突处理等方式上它都选择了非常简单明了的解决方案。



Raft将一致性拆分为几个关键元素：

- **Leader选举**
- **日志复制**
- **安全性**



#### 2. Raft的三个角色

Raft通过选举Leader并由Leader节点负责管理日志复制来实现多副本的一致性。



在Raft中，节点有三种角色：

- Leader：负责接收客户端的请求，将日志复制到其他节点并告知其他节点何时应用这些日志是安全的
- Candidate：用于选举Leader的一种角色
- Follower：负责响应来自Leader或者Candidate的请求



角色转换如下图所示：

![img](http://pcc.huitogo.club/34542ddb9f2c5f089d58b591095e1758)



其中：

- 所有节点初始状态都是Follower角色
- 超时时间内没有收到Leader的请求则转换为Candidate进行选举
- Candidate收到大多数节点的选票则转换为Leader；发现Leader或者收到更高任期的请求则转换为Follower
- Leader在收到更高任期的请求后转换为Follower



**那每个Leader的任期是多少？**

Raft把时间切割为任意长度的任期，每个任期都有一个任期号，采用连续的整数。

![img](http://pcc.huitogo.club/4e181848b312b2bcbcee36c2e84034fe)



每个任期都由一次选举开始，若选举失败则这个任期内没有Leader；如果选举出了Leader则这个任期内有Leader负责集群状态管理。



#### 3. 选举流程

初始是Follwer状态节点，等100-300MS没有收到LEADER节点的心跳就变候选人。候选人给大家发选票，候选人获得大多数节点的选票就变成了LEADER节点。

![img](http://pcc.huitogo.club/1a29c3c879b5c1756ed68aa58cdec2e7)



#### 4. 日志复制流程

每次改变数据先记录日志，日志未提交不能改节点的数值。然后LEADER会复制数据给其他follower节点，并等大多数节点写日志成功再提交数据。

![img](http://pcc.huitogo.club/df80cd196a76fbec8cf08c791abc5c01)



#### 5. 选举超时

每个节点随机等150到300MS，如果时间到了就开始发选票，因为有的节点等的时间短，所以它会先发选票，从而当选成主节点。但是如果两个候选人获得的票一样多，它们之间就要打加时赛，这个时候又会重新随机等150到300MS，然后发选票，直到获得最多票当选成主节点。

![img](http://pcc.huitogo.club/457eb42b9e2c910a5b5677842ada1c6c)



#### 6. 心跳超时

每个节点会记录主节点是谁，并且和主节点之间维持一个心跳超时时间，如果没有收到主节点回复，从节点就要重新选举候选人节点。

![img](http://pcc.huitogo.club/5979adf7c6e57ceed9e47937a2aadcfe)



#### 7. 集群中断

当集群之间的部分节点失去通讯时，主节点的日志不能复制给多个从节点就不能进行提交。

![img](http://pcc.huitogo.club/bc56500691f44b48bc31349986e109d2)



#### 8. 集群恢复

当集群恢复之后，原来的主节点发现自己不是选票最多的节点，就会变成从节点，并回滚自己的日志，最后主节点会同步日志给从节点，保持主从数据的一致性。

![img](http://pcc.huitogo.club/30decc74cae7ebeff724d2541b205228)