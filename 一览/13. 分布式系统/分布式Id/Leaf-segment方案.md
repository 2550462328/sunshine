**Leaf-segment方案**

Leaf这个名字是来自德国哲学家、数学家莱布尼茨的一句话： >There are no two identical leaves in the world > “世界上没有两片相同的树叶”



#### 1. 对Mysql优化（号段模式）

第一种Leaf-segment方案，在使用数据库的方案上，做了如下改变： - 原方案每次获取ID都得读写一次数据库，造成数据库压力大。改为利用proxy server批量获取，每次获取一个segment(step决定大小)号段的值。用完之后再去数据库获取新的号段，可以大大的减轻数据库的压力。 - 各个业务不同的发号需求用biz_tag字段来区分，每个biz-tag的ID获取相互隔离，互不影响。如果以后有性能需求需要对数据库扩容，不需要上述描述的复杂的扩容操作，只需要对biz_tag分库分表就行。



数据库表设计如下：

![img](http://pcc.huitogo.club/f3fbd3780a613c05bc51f1aeb2867a9a)



其中字段说明

- biz_tag用来区分业务
- max_id表示该biz_tag目前所被分配的ID号段的最大值
- step表示每次分配的号段长度



原来获取ID每次都需要写数据库，现在只需要把step设置得足够大，比如1000。那么只有当1000个号被消耗完了之后才会去重新读写一次数据库。读写数据库的频率从1减小到了1/step



大致架构如下图所示：

![img](http://pcc.huitogo.club/c521b1a76a25763d4193f8ddc371321f)



这种优化后的方案的优点：

1. Leaf服务可以很方便的线性扩展，性能完全能够支撑大多数业务场景。
2. ID号码是趋势递增的8byte的64位数字，满足上述数据库存储的主键要求。
3. 容灾性高：Leaf服务内部有号段缓存，即使DB宕机，短时间内Leaf仍能正常对外提供服务。
4. 可以自定义max_id的大小，非常方便业务从原有的ID方式上迁移过来。



缺点是：

1. ID号码不够随机，能够泄露发号数量的信息，不太安全。
2. TP999数据波动大，当号段使用完之后还是会hang在更新数据库的I/O上，tg999数据会出现偶尔的尖刺。
3. DB宕机会造成整个系统不可用。



#### 2. 双Buffer优化

目的在于优化上述方案的第2个缺点



Leaf 取号段的时机是在号段消耗完的时候进行的，也就意味着号段临界点的ID下发时间取决于下一次从DB取回号段的时间，并且在这期间进来的请求也会因为DB号段没有取回来，导致线程阻塞。如果请求DB的网络和DB的性能稳定，这种情况对系统的影响是不大的，但是假如取DB的时候网络发生抖动，或者DB发生慢查询就会导致整个系统的响应时间变慢。



为此，我们希望DB取号段的过程能够做到无阻塞，不需要在DB取号段的时候阻塞请求线程，即当号段消费到某个点时就异步的把下一个号段加载到内存中。而不需要等到号段用尽的时候才去更新号段。这样做就可以很大程度上的降低系统的TP999指标。



详细实现如下图所示：

![img](http://pcc.huitogo.club/72ea87bd0bbdd7a03f4a681f2716ce3e)



采用双buffer的方式，Leaf服务内部有两个号段缓存区segment。当前号段已下发10%时，如果下一个号段未更新，则另启一个更新线程去更新下一个号段。当前号段全部下发完后，如果下个号段准备好了则切换到下个号段为当前segment接着下发，循环往复。



每个biz-tag都有消费速度监控，通常推荐segment长度设置为服务高峰期发号QPS的600倍（10分钟），这样即使DB宕机，Leaf仍能持续发号10-20分钟不受影响。

每次请求来临时都会判断下个号段的状态，从而更新此号段，所以偶尔的网络抖动不会影响下个号段的更新。



#### 3. Leaf高可用容灾

目的在于优化上述方案的第3个缺点



可以采用**一主两从**的方式，同时**分机房**部署，Master和Slave之间采用半同步方式[5]同步数据。同时使用美团的Atlas数据库中间件(已开源，改名为[DBProxy](http://tech.meituan.com/dbproxy-introduction.html))做主从切换。当然这种方案在一些情况会退化成异步模式，甚至在非常极端情况下仍然会造成数据不一致的情况，但是出现的概率非常小。如果你的系统要保证100%的数据强一致，可以选择使用“类Paxos算法”实现的强一致MySQL方案，如MySQL 5.7前段时间刚刚GA的[MySQL Group Replication](https://dev.mysql.com/doc/refman/5.7/en/group-replication.html)。但是运维成本和精力都会相应的增加，根据实际情况选型即可。

![img](http://pcc.huitogo.club/c97b23a52242db680576623b1284f149)



同时Leaf服务分IDC部署，内部的服务化框架是“MTthrift RPC”。服务调用的时候，根据负载均衡算法会优先调用同机房的Leaf服务。在该IDC内Leaf服务不可用的时候才会选择其他机房的Leaf服务。同时服务治理平台OCTO还提供了针对服务的过载保护、一键截流、动态流量分配等对服务的保护措施。



到此Leaf-segment已经可以用在生产环境了，但是需要注意的是Leaf-segment方案可以生成趋势递增的ID，同时ID号是可计算的，**不适用于订单ID生成场景**，比如竞对在两天中午12点分别下单，通过订单id号相减就能大致计算出公司一天的订单量，这个是不能忍受的。