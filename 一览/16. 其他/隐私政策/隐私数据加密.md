#### 1. 隐私数据加密

最终目标

1. 新增数据时，字段自动加密后存储
2. 修改数据时，字段自动加密后修改
3. where条件中equal需要按照密文列加密算法加密内容后和密文列对比
4. where条件中like需要按照单字符摘要算法加密内容后和模糊列进行like



传统加密 磁盘加密、TDE(数据库产商内嵌)、应用层加密

TDE：由数据库厂商在数据库引擎中实现，数据在写入磁盘之前进行加密，从磁盘读入内存时进行解密，可以通过等保三级

应用层加密：在应用系统层的源代码中对敏感数据进行加密，加密后将密文存储到数据库中。可以直接在应用系统或者中间件中以独立的函数或模块形式完成加密。

推荐算法：国密SM4（对称）、SM2（非对称）；国际AES（对称）、RSA（非对称）



缺点：由于加密算法是将整串字符串加密，导致模糊搜索无法实现。

![img](http://pcc.huitogo.club/e2a9ca82f9351c0f212d504042051de1)



怎么解决字符串加密后，无法实现模糊搜索？



不推荐

1. 加载数据到内存数据库，从内存数据库中模糊搜索 - 吃内存
2. 数据库中实现解密函数（跟应用层加密对应） - 风险大



推荐，**新增模糊列** 专门进行模糊查询

1. 脱密存储，对加密字段脱密存储到模糊列，比如手机号 脱敏后是 187****4993，还是可以进行部分模糊查询的 - 不实用
2. 字段 按固定长度 进行排列组合后（全排列）存储到模糊列 ，比如ningyu1使用4个字符为一组的加密方式，第一组ning ，第二组ingy ，第三组ngyu ，第四组gyu1 … 依次类推，全部加密之后存储到模糊查询列。

如果需要检索所有包含检索条件4个字符的数据比如：ingy，加密字符后通过 keylike “%partial%” 查库。

淘宝、拼多多、JD他们的API，他们对平台订单数据中的用户敏感数据就是加密的同时支持模糊查询，使用就是这个方法。



缺点：

1）存储成本增加

- 自由分组会增加数据量
- 加密后长度会增长

2）模糊查询长度有限制

由于安全问题，自由组合长度不能太低，不然可以采取彩虹表破解。

对模糊查询的字符长度是有要求的，以我上面举的例子模糊查询字符原文长度必须大于等于4个英文/数字，或者2个汉字才能搜索到结果



结合数据脱敏 和 排列组合 使用单字符摘要算法

原理大致是使用一个掩码mask，原字符的unicode码 和 mask码进行位与操作得出一个新的unicode码，将这些 unicode码 放入模糊列 进行模糊搜索



问题1：每个字符串会根据丢失的位数，反推出来的结果为2^n。因为常见汉字的unicode码在十进制时间隔都很大，可以发现反推出来的汉字基本都不是常用字，反推出原字的几率比较大。

解决：使用unicode码的后几位做下标在unicode表中查询常见字



问题2：就是unicode码留几位的问题，留的多查询精度高一点，但是1:1还原的字数也变多了；留的少了查询精度稍弱，但是1:1还原的字就少了；1:1还原字决定了推理出原文的可能性

![img](http://pcc.huitogo.club/48fcbc8ccfc2b4e625c73ac842d7cf19)



解决：增加乱序字典表，先将加密文字在乱序字典表中的下标作从unicode字典表中的下标。然后和mask掩码作位与操作。

![img](http://pcc.huitogo.club/5dadb203c6196afa2f51cc236d52ef84)



加密算法实现如下：

![img](http://pcc.huitogo.club/f962ab8173dd7f5bc154c17a54bd01ba)



**业务中如何实现无缝融入**



以mybatis为例：

自定义拦截器和注解

Mybatis的Interceptor（拦截器），可以用来拦截SQL的参数处理、SQL语句构建、SQL执行和返回结果处理等阶段。要实现字段的加解密，可以通过自定义两个拦截器：参数处理拦截器和结果集拦截器，在参数处理拦截器中对字段进行加密，在结果集拦截器中对字段进行解密。



限制：

该方案类似实现起来要比较麻烦，而且只能解决注解标记的对象操作。



思路：

是否能将SQL解析变成代码可以处理的东西，然后根据规则进行处理重新组装成SQL执行，这样就不再局限于框架和对象。我们发现AST（抽象语法树）刚好就是来处理这个事情的，大家经常用到的druid连接池就用到了AST抽象语法树（用来实现防御SQL注入、合并统计没有参数化、 SQL格式化、分库分表）。



AST（抽象语法树）

解析过程分为词法解析和语法解析。 词法解析器用于将 SQL 拆解为不可再分的原子符号，称为 Token。并根据不同数据库方言所提供的字典，将其归类为关键字，表达式，字面量和操作符。 再使用语法解析器将词法解析器的输出转换为抽象语法树。

例如，以下 SQL：

```
SELECT id, name FROM t_user WHERE status = 'ACTIVE' AND age > 18
```



解析之后的为抽象语法树见下图。

![img](http://pcc.huitogo.club/61ec6c95b99c295596518f95f89c7f79)



抽象语法树中的关键字的 Token 用绿色表示，变量的 Token 用红色表示，灰色表示需要进一步拆分。

最后，通过 visitor 对抽象语法树遍历构造域模型，通过域模型（SQLStatement）去提炼分片所需的上下文，并标记有可能需要改写的位置。 供分片使用的解析上下文包含查询选择项（Select Items）、表信息（Table）、分片条件（Sharding Condition）、自增主键信息（Auto increment Primary Key）、排序信息（Order By）、分组信息（Group By）以及分页信息（Limit、Rownum、Top）。 SQL 的一次解析过程是不可逆的，一个个 Token 按 SQL 原本的顺序依次进行解析，性能很高。 考虑到各种数据库 SQL 方言的异同，在解析模块提供了各类数据库的 SQL 方言字典。



生成 SQL-AST

主要包括三个步骤：

1. 通过 SQLParserEngine 生成 SQL 抽象语法树。
2. 通过 SQLSegmentsExtractorEngine 提取 SQLSegment。
3. 通过 SQLStatementFiller 填充 SQLStatement。

![img](http://pcc.huitogo.club/20c2afdc866f9f1ff633db4d209b646e)



**AST调研**

前面介绍了AST，然后我们准备朝着SQl解析改写的思路去做加解密和查询改写，调研到Druid的SQL Parser。



Druid SQL Parser

通过代码的方式实现词法解析器和语法解析器

支持多种DB: Mysql, PostgreSQL, SQLServer, Oracle, odps, db2, hive, SQL92

SQL 格式化，SQL参数化

支持自定义visitor

该方案可以需要自己定义visitor去实现各种场景下SQL的加解密和字段改写，工作量和测试量非常大。此时我们发现ShardingSphere-JDBC正是按照这个思路内置实现了数据加密模块。



**ShardingSphere-JDBC数据加密**

ShardingSphere 通过对用户输入的 SQL 进行解析，并依据用户提供的加密规则对 SQL 进行改写，从而实现对原文数据进行加密，并将原文数据（可选）及密文数据同时存储到底层数据库。 在用户查询数据时，它仅从数据库中取出密文数据，并对其解密，最终将解密后的原始数据返回给用户。 ShardingSphere 自动化 & 透明化了数据加密过程，让用户无需关注数据加密的实现细节，像使用普通数据那样使用加密数据。

![img](http://pcc.huitogo.club/b2e6b4ebd0f396540eec3d795e6ce8ee)



加密规则

加密配置主要分为四部分：数据源配置，加密算法配置，加密表配置以及查询属性配置，其详情如下图所示：

![img](http://pcc.huitogo.club/0fa8b1ee0f44edd8dfaa678322c96e4e)



1. 加密算法配置：指使用什么加密算法进行加解密。目前 ShardingSphere 内置了五种加解密算法：AES，MD5，RC4，SM3 和 SM4。用户还可以通过实现 ShardingSphere 提供的接口，自行实现一套加解密算法。
2. ogicColumn列的意义：最终目的是希望屏蔽底层对数据的加密处理，不需要让用户知道数据是如何被加解密的、如何将明文数据存储到 plainColumn，将密文数据存储到 cipherColumn，将辅助查询数据存储到 assistedQueryColumn。



加密、转换流程

![img](http://pcc.huitogo.club/d12bd42f7aaf6735fc23db04f9ea0731)



1. 插入时实现：插入列自动增加字段，原文按照相应加密规则加密插入
2. 更新时实现：修改列自动增加字段，原文按照相应加密规则加密修改，where语句自动改写
3. 查询时实现：where语句自动改写，结果自动解密



缺点：where加密字段常见操作实现了eq，不支持like查询。



ShardingSphere-JDBC二次开发

思路：单字符摘要算法，可以解决like查询的问题，还不会带来分词组合庞大的数据压力，所以我们准备按照官方的这个思路增加fuzzyQueryColumn列用来实现模糊查询。

![img](http://pcc.huitogo.club/1f64d4b96f17257721e82ae63b57d06c)



**ShardingSphere-JDBC使用限制**



1）数据加密模块限制

加密字段无法支持查询不区分大小写功能；

加密字段无法支持比较操作，如：大于、小于、ORDER BY、

BETWEEN、LIKE （结合fuzzyQueryColumn可以支持）等；

加密字段无法支持计算操作，如：AVG、SUM 以及计算表达式。



2）数据分片模块限制

无法支持：

- CASE WHEN 中包含子查询
- CASE WHEN 中使用逻辑表名（请使用表别名）

不稳定支持：

- 子查询和外层查询未同时指定分片键，或分片键的值不一致时。
- 当关联查询中的多个表分布在不同的数据库实例上时

![img](http://pcc.huitogo.club/be7a1993b57f1f2f20d247e308d90561)

![img](http://pcc.huitogo.club/cf43f8ec36975fa945fbe8117b55c768)



**隐私数据加密建议（总结）**

1. 改造量较少，使用提供的Fuzzy算法，手动改造即可。
2. 改造量较大，使用二次开发的Sharding-JDBC加密模块