**为什么会出现这么多上线部署方案？**

- 随着业务的快速发展，运维集中上线工作量大
- 产品的部署升级要求能在白天业务低峰期进行，并且要求服务不间断，用户无感知
- 紧急问题修复完成随时快速上线，或者需要在线联调功能
- 为了确保上线产品的质量，需要生产环境提供上线前的验证UAT环境
- 业务线本身场景决定不能长时间停服升级，如果急诊和住院场景



![img](http://pcc.huitogo.club/3b948aa6b2bb964ab099e11c0d803957)



#### 1. 金丝雀（灰度发布）

此方式实现不停机发布，并且通过分流实现新旧并行，出问题后也可区分出新旧环境

![img](http://pcc.huitogo.club/4f499c1eb2b240ee9785e784d7b310e8)



#### 2. 滚动发布

利用k8s现有的支持，实现不停机发布，并没有灰度发布明确的分流，出问题后不能快速区分出新旧环境，滚动发布主要体现出自动的发布策略依赖自动发布工具。

![img](http://pcc.huitogo.club/4f7da22e61254987d78a6c3884ae2de4)



#### 3. A/B测试

AB测试其实不算是部署发布的策略，更多的是用来对比效果。AB测试是为Web或App界面或流程制作两个（A/B）或多个（A/B/n）版本，在同一时间维度，分别让组成成分相同（相似）的访客群组（目标人群）随机的访问这些版本，收集各群组的用户体验数据和业务数据，最后分析、评估出最好版本，正式采用。通过A/B测试，降低新产品或新特性的发布风险，为产品创新提供保障。

A/B测试与一般工程测试的区别

A/B测试，用于验证用户体验、市场推广等是否正确，而一般的工程测试主要用于验证软硬件是否符合设计预期，因此AB测试与一般的工程测试分属于不同的领域。

![img](http://pcc.huitogo.club/a10c56e48c78952832b361ac3f23badf)



#### 4. 蓝绿部署

蓝色环境中可以随时根据测试反馈进行代码修正并以完全和公网服务一致的情况下得到验证。当发布后，蓝色环境接入现网提供完整服务，如果有什么问题，则可以立刻切回绿色系统，一段时间的验证无误，则蓝绿环境身份对调，进行下个版本的测试，或者直接释放掉旧的绿色环境。

![img](http://pcc.huitogo.club/1e3083b7941fce92f4c0753fc146f8e9)



**蓝绿方案的优缺点**

1）收益

对业务本身无侵入性 上线前的UAT环境验证，提升产品的稳定性和上线版本的质量

业务运行期离线部署新版本，并完成功能验证，业务低峰期进行环境切换

减轻研发、测试、运维人员的上线压力和周期。



2）代价

蓝绿部署额外需要一套硬件资源

数据库蓝绿代价较高

环境准备和环境切换运维工作量大



3）优化方案

最大化复用基础环境和中间件，采用命名空间隔离和文件夹隔离，降低物理资源的投入。

数据同步涉及的技术复杂度高，对业务影响较大，前期不考虑蓝绿。

人工操作环境同步和环境切换，涉及文件的复制和配置的修改，工作量大且易出错，提供自动化工具。