LVS ( Linux Virtual Server ）是一个虚拟 的服务器集群系统，采用 IP 负 载均衡技术将 请求均衡地转移到不 同的服务器上执行，且通过调度器自动屏蔽故障服务器，从而将一 组服务器构成一个高性能 、高可用的虚拟服务器 。 整个服务器集群的结构对用户是透明 的，无须修改客户端和服务器端的程序，便可实现客户端到服务器的负载均衡 。



#### 1. LVS 的原理

LVS 由前端的负载均衡器（ Load Balancer, LB ）和后端的真实服务器（ Real Server, RS ）群组成，在真实服务器间可通过局域网或广域网连接 。 LVS 的这种结构对用户是透明 的，用户只需要关注作为 LB 的虚拟服务器（ Virtual Seiver ），而不需要关注提供服务的真 实服务器群 。 在用户的请求被发送给虚拟服务器后， LB 根据设定 的包转发策略和负载均衡 调度算法将用户的请求转发给真实服务器，真实服务器再将用户请求的结果返回 给用户 。



实现 LVS 的核心组件有负载均衡调度器、服务器池和共享存储 。

- **负载均衡调度器**（ Load Balancer/Director ） ： 是整个集群对外提供服务的入口，通 过对外提供一个虚拟 IP 来接收客户端请求 。 在客户端将请求发送到该虚拟 IP 后， 负载均衡调度器会负责将请求按照负载均衡策略发送到一组具体的服务器上 。
- **服务器池**（ server Pool )： 服务器池是一组真正处理客户端请求 的真实服务器，具 体执行的服务有 WEB 、 MAIL 、 FTP 和 DNS 等 。
- 共享存储（ Shared Storage ） ： 为服务器池提供一个共享的存储区，使得服务器池 拥有相 同 的 内容 ， 提供相同的服务 。



在接收 LVS 内部数据的转发流程前 ， 这里先介绍 LVS 技术 中 常用 的一些名 词 ，以让我们更好地理解 LVS 的工作原理

![img](http://pcc.huitogo.club/6d1843487a2272d9fd7018845078dd93)



LVS 的 IP 负载均衡技术是通过 IPVS 模块实现的 。 IPVS 是 LVS 集群系统 的核心软件， 被安装在 Director Server 上，同时在 Director Server 上虚拟出一个 IP 地址 。 用户通过这 个虚拟的 IP 地址访问服务器 。 这个虚拟的 IP 地址一般被称为 LVS 的 VIP ， 即 Virtua l IP 。

访问 的请求首先经过 VIP 到达负载调度器，然后由负载调度器从真实服务器列表中选取 一个服务节点 响应用户 的请求 。



#### 2. LVS 数据转发

LVS 的数据转发流程是 LVS 设计 的核心部分，如下所述，如图所示 。

![img](http://pcc.huitogo.club/ba2671fc6978e392bec7e142d4f5f535)

1. PREROUTING 链接收用户请求 ： 客户 端 向 PREROUTING 链发送请求 。
2. INPUT 链转发 ：在 PREROUTING 链通过 RouteTable 列表发现请求数据包的目 的地址是本机时，将数据包发送给 INPUT 链 。
3. IPVS 检查 ： IPVS 检查 INPUT 链上的数据包， 如果数据包中的 目的地址和端口 不在规则列表 中 ， 则将该数据包发送到用户空 间的 ipvsadm 。 ipvsadm 主要用于用户定义 和管理集群 。
4. POSTROUTING 链转发 ： 如果数据包里面的目的地址和端口都在规则里面，那 么将该数据包中的目的地址修改为事先定义好的真实服务器地址 ，通过 FORWARD 将数 据发送到 POSTROUTING 链 。
5. 真实服务器转发： POSTROUTING 链根据数据包中的目的地址将数据包转发到 真实服务器 。



#### 3. LVS NAT 模式

LVS NAT ( Network Address Translation ）即网络地址转换模式，具体的实现流程如 图所示 。



![img](http://pcc.huitogo.club/7ddd2f8ce0c5d72664726533788655d5)



NAT 模式通 过对请求报文和响应报文的地址进行改写完成对数据的转发，具体流程如下 。

1. 客户端将请求报文发送到 LVS ，请求报文的源地址是 CIP ( Client IP Address, 客户端 IP ），目标地址是 VIP ( Virtual IP Address ，虚拟 IP ）。
2. LVS 在收到报文后，发现请求的 IP 地址在 LVS 的规则列表中存在，则将客户端请求报文的目标地址 VIP 修改为 RIP (Real-server IP Address ，后端服务器的真实 IP), 并将报文发送到具体的真实服务器上 。
3. 真实服务器在收到报文后，由于报文的目标地址是自己的 IP ，所以会响应该请求，并将响应报文返回给 LVS 。
4. LVS 在收到数据后将此报文的源地址修改为本机 IP 地址，即 VIP ，并将报文发送给客户端 。



NAT 模式的特点如下 。

1. 请求的报文和响应的报文都需要通过 LVS 进行地址改写 ，因此在并发访 问量较大 的时候 LVS 存在瓶颈 问 题， 一般适用于节点不是很多的情况下 。
2. 只需要在 LVS 上配置一个公网 IP 即可 。
3. 每台内部的真实服务器 的网关地址都必须是 LVS 的内网地址 。
4. NAT 模式支持对 IP 地址和端口进行转换，即用户 请求 的端口和真实服务器 的端 口可以不同 。



#### 4. LVS DR 模式

LVS DR ( Direct Routing ）模式用直接路由 技术实现，通过改写请求报文 的 MAC 地 址将请求发送给真实服务器，具体的实现流程如图所示 。

![img](http://pcc.huitogo.club/d9c0c0383d110e184b019f8c02baec62)



LVD DR 模式是局域网中 经常被用到的一种模式，其报文转发流程如下 ：

1. 客户端将请求发送给 LVS ，请求报文的源地址是 CIP ，目标地址是 VIP 。
2. LVS 在收到报文后，发现请求在规则中存在，则将客户端请求报文的源 MAC 地 址改为自己的 DIP ( Direct IP Address ，内部转发 IP ）的 MAC 地址，将目标 MAC 改为 RIP 的 MAC 地址，并将此包发送给真实服务器 。
3. 真实服务器在收到请求后发现请求报文中的目标 MAC 是自己，就会将此报文接 收下来，在处理完请求报文后，将响应报文通过 lo （回环路由）接口发送给 ethO 网卡， 并最终发送给客户端 。



NAT 模式的特点如下 ：

1. 通过 LVS 修改数据包的目的 MAC 地址实现转发 。 注意，源 IP 地址仍然是 CIP, 目标 IP 地址仍然是 VIP 地址 。
2. 请求的报文均经过 LVS ，而真实服务器响应报文时无须经过 LVS ，因此在并发访 问量大时比 NAT 模式的效率高很多 。
3. 因为 DR 模式是通过 MAC 地址改写机制实现转发的，因此所有真实服务器节点 和 LVS 只能被部署在同 一个局域网内 。
4. 真实服务器主机需要绑定 VIP 地址在 lo 接口（掩码 32 位）上，并且需要配置 ARP 抑制 。
5. 真实服务器节点的默认网关无须被配置为 LVS 网关，只需要被配置为上级路由的 网关，能让真实服务器直接出网即可 。
6. DR 模式仅做 MAC 地址的改写，不能改写目标端口，即真实服务器端口和 VIP 端口必须相同。



#### 5. LVS TUN 模式

TUN (IP Tunn巳ling ）通过 IP 隧道技术实现，具体的实现流程如图所示 。

![img](http://pcc.huitogo.club/afb18daac6e534d235d33230747a81b6)

LVS TUN 模式常用于跨网段或跨机房 的负载均衡，具体的报文转发流程如下 ：

1. 客户端将请求发送给前端的 LVS ，请求报文的源地址是 CIP ，目标地址是 VIP。
2. LVS 在收到报文后，发现请求在规则里中存在，则将在客户端请求报文的首部 再封装一层 IP 报文，将源地址改为 DIP ，将目标地址改为 RIP ，并将此包发送给真实服务器 。
3. 真实服务器在收到请求报文后会先拆开第 l 层封装，因为发现里面还有一层 IP 首部的目标地址是自己 lo 接口上的 VIP ，所以会处理该请求报文，并将响应报文通过 lo 接口发送给 ethO 网卡， 并最终发送给客户端。



TUN 模式的特点如下 。

1. UNNEL 模式需要设置 l o 接口的 VIP 不能在公 网上出现 。
2. TUNNEL 模式必须在所有的真实服务器上绑定 VIP 的 IP 地址 。
3. TUNNEL 模式中 VIP→真实服务器的包通信通过 TUNNEL 隧道技术实现，不管 是内网还是外网都能通信，所以不需要 LVS 和真实服务器在同 一个网段内 。
4. 在 TUNNEL 模式中，真实服务器会把响应报文直接发送给客户端而不经过 LVS, 负载能力较强 。
5. TUNNEL 模式采用的是隧道模式，使用方法相对复杂，一般用于跨机房 LVS 实 现，并且需要所有服务器都支持 IP Tunneling 或 IP Encapsulation 协议。



#### 4. LVS FULLNAT模式

无论是 DR 模式还是 NAT 模式，都要求 LVS 和真实服务器在 同一个 VLAN 下， 否 则 LVS 无法作为真实服务器 的网关，因 此跨 VLAN 的真实服务器无法接入 。 同时，在流 量增大、真实服务器水平扩容时，单点 LVS 会成为瓶颈 。

FULLNAT 能够很好地解决 LVS 和 真实服务器跨 VLAN 的问题，在跨 VLAN 问题解 决后， LVS 和真实服务器不再存在 VLAN 上的从属关系，可以做到多个 LVS 对应多个真 实服务器，解决水平扩容的问题 。 FULLNAT 的原理是在 NAT 的基础上引人 Loca Address IP （内网 IP 地址），将 CIP→VIP 转换为 LIP→RIP ，而 LIP 和 RIP 均为 IDC 内网 IP ，可以通过交换机实现跨 VLAN 通信 。



FULLNAT 的具体实现流程如图所示 ：

![img](http://pcc.huitogo.club/8c60785f4d8b6266513fb1bed17b8d38)



LVS FULLNAT 具体的报文转发流程如下 。

1. 客户端将请求发送给 LVS 的 DNAT ，请求报文的源地址是 CIP ，目标地址是 VIP 。
2. LVS 在收到数据后将源地址 CIP 修改成 LIP ( Local IP Address, LVS 的内网 IP), 将目标地址 VIP 修改为 RIP ，并将数据发送到真实服务器 。 多个 LIP 在同一个 IDC 数据 中心，可以通过交换机跨 VLAN 通信 。
3. 真实服务器在收到数据包并处理完成后，将目标地址修改为 LIP ，将源地址修改 为 RIP ，最终将这个数据包返回给 LVS 。
4. LVS 在收到数据包后，将数据包中的目标地址修改为 CIP ，将源地址修改为 VIP, 并将数据发送给客户端。