我们先简单了解一下MySQL大概的架构：

![img](http://pcc.huitogo.club/ff191e697078172dde0bcefcfd212f72)

MySQL服务层负责SQL语法解析、生成执行计划等，并调用存储引擎层去执行数据的存储和检索。

索引下推的下推其实就是指**将部分上层（服务层）负责的事情，交给了下层（引擎层）去处理**。



我们来具体看一下，在没有使用ICP的情况下，MySQL的查询：

1. 存储引擎读取索引记录；
2. 根据索引中的主键值，定位并读取完整的行记录；
3. 存储引擎把记录交给Server层去检测该记录是否满足WHERE条件。



使用ICP的情况下，查询过程：

1. 存储引擎读取索引记录（不是完整的行记录）；
2. 判断WHERE条件部分能否用索引中的列来做检查，条件不满足，则处理下一行索引记录；
3. 条件满足，使用索引中的主键去定位并读取完整的行记录（就是所谓的回表）；
4. 存储引擎把记录交给Server层，Server层检测该记录是否满足WHERE条件的其余部分。



**索引下推使用条件**

- 只能用于range、 ref、 eq_ref、ref_or_null访问方法；
- 只能用于InnoDB和 MyISAM存储引擎及其分区表；
- 对InnoDB存储引擎来说，索引下推只适用于二级索引（也叫辅助索引）; 索引下推的目的是为了减少回表次数，也就是要减少IO操作。对于InnoDB的聚簇索引来说，数据和索引是在一起的，不存在回表这一说。
- 引用了子查询的条件不能下推；
- 引用了存储函数的条件不能下推，因为存储引擎无法调用存储函数。