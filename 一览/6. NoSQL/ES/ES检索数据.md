#### 1. 根据文档读

ElasticSearch 在处理读取请求时，协调节点在每次收到客户端请求的时候都会通过轮 询所有副本分片来达到负载均衡 。 当检索时，被索引的文档可能已经在主分片上，但是 还没有同步到副本分片 。 在这种情况下 ，副本分片可能会报告文档不存在，但是主分片 可能会成功返回文档 。一旦索引请求成功返回用户，文档在主分片和副本分片上都是可 用的 。



ElasticSearch 文档的读取流程如图所示

![img](http://pcc.huitogo.club/afb21e8a6f7c12bad0d9dd6b21c5ce8e)



1. 客户端向 Node-1 发送文档读取请求。
2. 协调节点 Node-1 根据文档的_id来确定文档属于分片1。 分片 1的文档数据存在所有 3 个节点上 。 在这种情况下 ， 它将请求转发到 Node-2。
3. Node-2 在本地执行查询操作并将查询结果返回到 Node-1。
4. Node- 1( 此时 Node-1为 CoordinatingNode 角色)接收 Node-2 的查询结果，如 果查询到请求对应的文挡 ，则将该文档返回客户端 。 如果在 Node-2 上未查询到对应的文 档数据，则 Node-1 会继续向其他节点发送文档读取请求，直到查询到文档对应的数据后 才返回 。 如果要读取的文档在所有节点上都不存在，则向客户端报告文档不存在。



#### 2. 搜索数据过程

![img](http://pcc.huitogo.club/1a26f0fc38ad3e1ef1748458c0de1e35)

搜索被执行成一个两阶段过程，我们称之为 **Query Then Fetch**；

1）在初始查询阶段时，查询会广播到索引中每一个分片拷贝（主分片或者副本分片）。 每个分片在本地执行搜索并构建一个匹配文档的大小为 from + size 的优先队列。

注意：在搜索的时候是会查询 Filesystem Cache 的，但是有部分数据还在 MemoryBuffer，所以搜索是近实时的。



2）每个分片返回各自优先队列中 所有文档的 ID 和排序值 给协调节点，它合并这些值到自己的优先 队列中来产生一个全局排序后的结果列表。



3）接下来就是取回阶段，协调节点辨别出哪些文档需要被取回并向相关的分片提交多个 GET 请求。



4）每个分片加载并丰富文档，如果有需要的话，接着返回文档给协调节点。一旦所有的文档都被取回 了，协调节点返回结果给客户端。

补充：Query Then Fetch 的搜索类型在文档相关性打分的时候参考的是本分片的数据，这样在文 档数量较少的时候可能不够准确，DFS Query Then Fetch 增加了一个预查询的处理，询问 Term 和 Document frequency，这个评分更准确，但是性能会变差。



