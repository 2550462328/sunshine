#### 1. 同步双写

![img](http://pcc.huitogo.club/57b19309f29c89904c5da8509b0a24a9)



优点：实现简单



缺点：

- 业务耦合，商品的管理中耦合大量数据同步代码
- 影响性能，写入两个存储，响应时间变长
- 不便扩展：搜索可能有一些个性化需求，需要对数据进行聚合，这种方式不便实现



#### 2. 异步双写

![img](http://pcc.huitogo.club/e768264814fc20a0d6f866e7fd1d1701)



这种场景一些数据需要聚合处理成类似宽表的结构怎么办呢？例如商品库的商品品类、spu、sku表是分开的，但是查询是跨维度的，在ES里再聚合一次效率就低一些，最好就是把商品的数据给聚合起来，在ES里以类似大宽表的形式存储，这样一来查询效率就高一些。

这种其实没什么好办法，基本上还是得搜索服务直接查库，或者远程调用，再查询一遍商品的数据库，就是所谓的回查。

![img](http://pcc.huitogo.club/b918a4a1291dea6df20e37e5f7c45c40)



优点：

- 解耦合，商品服务无需关注数据同步
- 实时性较好，使用MQ，正常情况下，同步完成在秒级



缺点：

引入了新的组件和服务，增加了复杂度



#### 4. 定时任务

![img](http://pcc.huitogo.club/aa24c91e6345eb5994133174a09cf4d0)



定时任务，最麻烦的一点是频率不好选，频率高的话，会非自然地形成业务的波峰，导致存储的CPU、内存占用波峰式上升，频率低的话实时性比较差，而且也有波峰的情况。



优点：实现比较简单



缺点：

- 实时性难以保证
- 对存储压力较大



#### 4. 数据订阅

MySQL通过binlog订阅实现主从同步，各路数据订阅框架比如canal就依据这个原理，将client组件伪装成从库，来实现数据订阅。

![img](http://pcc.huitogo.club/168e3d7c8411ef8d9e4ab67600fc10d9)



至于数据订阅框架的选型，主流的大体上是这些：

![img](http://pcc.huitogo.club/da2ed642f4f16de4da73dfba6d9560c3)



我们以应用最广泛的canal为例，canal通过canal-adapter，支持多种适配器，其中就有ES适配器，通过一些配置，启动之后，就可以直接把MySQL数据同步到ES，这个过程是零代码的。

![img](http://pcc.huitogo.club/9c14cd7de8e0583c80487db8d76c44e5)



前面提到的多张表数据聚合，canal的支持没那么好，所以还是得回查。这时候用canal-adapter就不合适了，需要自己实现canal-client，监听和聚合数据，写入ES：|

![img](http://pcc.huitogo.club/c73bd267f0a548baceedcbc741b3b9ae)



这种看起来和异步双写比较像，但是第一降低了商品服务的耦合，第二数据的实时性更好。



优点：

- 业务入侵较少
- 实时性较好