Lucene 的全文检索流程包括索引创建和索引查询两个过程。其中，索引创建分为获取文档、构建文档对象、文档分词和创建索引4 个步骤。查询索引分为调用查询接口、 创建查询、执行查询和结果返回 4 个步骤。



Lucene 的全文检索流程如图所示：

![img](http://pcc.huitogo.club/117fbb34d314da8ef3260a9797f0fdd0)



#### 1. 创建索引

创建索引指对用户要搜索的文档内容执行创建索引操作，并将索引结果存储在倒排索引库中 。



具体步骤如下 ：

**1）获取文档**：获取文档的过程即数据采集的过程。 Lucene 中的文档指要索引和搜索的原始内容。文档内容可以是互联网上的网页、数据库中的数据、磁盘上的日志文件 等。



**2）构建文档对象**：获取文档内容后，需要根据文档内容构建文档( Document ) 对象，每个文档对象都包含一个唯一的文档 id 和多个 Field ，每个 Field 中都存储着不同 的文档内容 。 例如，将磁盘上一个包含一篇文章的 TXT 文件当成一个 Document ，则 Document中包含多个 Field。每个 Field 都包含不同的内容，比如 file_name (文件名称)、 file_path (文件路径)、file_size (文件大小)、 file_content (文件内容 )。



Lucene文档的 数据结构如图所示：

![img](http://pcc.huitogo.club/b2e2a275b53433b44c24e3daab19dd21)



Field 的属性配置如下 。

- Tokenized （是否分词）：是否对 Field 的内容进行分词处理 。 当我们要对 Field 的 内容进行查询时，需要开启分析功能。
- Indexed （是否索引）: 是有将 Field 分词后的词或整个 Field 值进行索引 ，只有经 过索引的 FieId 才能被搜索 。
- Stored (是否存储)：是否将 Field 值存储在文档中，只有存储在文档中的 Field 值才可以从文档中被获取 。



**3）分析文档**：分析文档的过程是将原始内容创建为包含 Field 的 文档 ( Document ) 并对 Field 的内容进行分析的过程 。 分析文档的过程需要对原始文档执行提取单词 、 大小 写转换 、 去除标点符号 、 去除停用词等操作，然后生成最终的语汇单元 。



如下为 一个分析文档的过程 。

```
原文档内容 Lucene is a Java full-text search engine
分析后得到的语汇单元 lucene 、 java 、 full 、 search 、 engine
```



语汇单元中的每个单词都被叫作一个 Term ，不同的 Field 拆分出来的相同单词是不同的 Term。Term 中包含两部分：一部分是文档的 Field 名称，另 一部分是单词的内容 。



4）**创建索引**：创建索引指对所有文档分析得出的 Term 都进行索引并记录该 Term 在每个 Document 中出现的次数的过程 ，如下表所示为不同的 Term 在不同的文档中 ( Document1和Document2 ) 出现的次数 。 索引的目的是搜索 ， 最终要通过搜索被索引的语汇单元查找文档信息 。

![img](http://pcc.huitogo.club/0f8b630f8fe2ab06b691d0f7a47c81f0)



#### 2. 查询索引

查询索引即根据用户输入的关键字，从索引( lndex )中进行搜索的过程 。 



查询索引的具体过程为：根据关键字搜索索引，根据索引找到对应的文档 ，从而找到要搜索的内容 。

1）用户查询接口：全文检索系统提供的用户搜索界面，实现用户搜索关键字或关 键词的提交，以及搜索完成后搜索结果的展示。

2）创建查询对象：用户在输入关键字执行搜索之前，需要先构建一个查询对象。 查询对象中可以指定要搜索的文档 Field 、关键字等。查询对象会生成具体的查询语法 （例如" fileName:Lucene" 表示要搜索 Field 的内容为 "Lucene" 的文档）。

3）执行查询：根据查询语法在倒排索引词典表中分别找出对应搜索词的索引， 从 而找到索引对应的文档链表。搜索过程为在索引中查找 Field 为 fileName 且关键字为 Lucene 的 Term ，然后根据 Term 找到对应的文档 id 列表 。

4）返回查询结果：将查询的文档 id 列表返回到用户查询接口。