![img](http://pcc.huitogo.club/511d0022a6d777e5b48c065013fbfd57)

![img](http://pcc.huitogo.club/23a7fe924238992b76b725d659428123)

从更底层来看

![img](http://pcc.huitogo.club/08becca4242781636adc2ce7a9be4e00)



总体来说分为以下几个过程:

1. DNS解析
2. TCP连接
3. 发送HTTP请求
4. 服务器处理请求并返回HTTP报文
5. 浏览器解析渲染页面
6. 连接结束



#### 1. DNS解析

DNS解析的过程就是寻找哪台机器上有你需要资源的过程。

![img](http://pcc.huitogo.club/170124b043272552e036096a6a7665cd)



DNS解析是一个递归查询。



上述图片是查找www.google.com的IP地址过程。首先在本地域名服务器中查询IP地址，如果没有找到的情况下，本地域名服务器会向根域名服务器发送一个请求，如果根域名服务器也不存在该域名时，本地域名会向com顶级域名服务器发送一个请求，依次类推下去。直到最后本地域名服务器得到google的IP地址并把它缓存到本地，供下次查询使用。从上述过程中，可以看出网址的解析是一个从右向左的过程: com -> google.com -> www.google.com。但是你是否发现少了点什么，根域名服务器的解析过程呢？事实上，真正的网址是www.google.com.，并不是我多打了一个.，这个.对应的就是根域名服务器，默认情况下所有的网址的最后一位都是.，既然是默认情况下，为了方便用户，通常都会省略，浏览器在请求DNS的时候会自动加上，所有网址真正的解析过程为: . -> .com -> google.com. -> www.google.com.。



**那上述这么复杂的DNS解析过程能不能优化呢？**

**当然可以。**



**DNS存在着多级缓存**，从离浏览器的距离排序的话，有以下几种: 浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存。

另需要注意的是**DNS负载均衡**，也就是我们发现DNS返回的IP地址不一定每次都一样。

其实真实的互联网世界背后存在成千上百台服务器，大型的网站甚至更多。但是在用户的眼中，它需要的只是处理他的请求，哪台机器处理请求并不重要。DNS可以返回一个合适的机器的IP给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是DNS负载均衡，又叫做DNS重定向。大家耳熟能详的CDN(Content Delivery Network)就是利用DNS的重定向技术，DNS服务器会返回一个跟用户最接近的点的IP地址给用户，CDN节点的服务器负责响应用户的请求，提供所需的内容。



#### 2. TCP连接

HTTP协议是使用TCP作为其传输层协议的，当TCP出现瓶颈时，HTTP也会受到影响。

TCP连接需要经过三次握手，TCP断开连接需要经过四次挥手。

具体看网络层TCP协议



#### 3. 服务器处理

![img](http://pcc.huitogo.club/b661c53e1e6892618b0718df283c8e3e)



HTTP请求报文是由三部分组成: **请求行**, **请求报头**和**请求正文**。

请求行常用方法有GET, POST, PUT, DELETE, OPTIONS, HEAD



常用请求报头项有

1）**HTTP请求头**，HTTP客户程序（例如浏览器），向服务器发送请求的时候必须指明请求类型（一般是GET或者POST）。如有必要，客户程序还可以选择发送其他的请求头。

- Accept：浏览器可接受的MIME类型。
- Accept-Charset：浏览器可接受的字符集。
- Accept-Encoding：浏览器能够进行解码的数据编码方式，比如gzip。Servlet能够向支 持gzip的浏览器返回经gzip编码的HTML页面。许多情形下这可以减少5到10倍的下 载时间。
- Accept-Language：浏览器所希望的语言种类，当服务器能够提供一种以上的语言版本 时要用到。
- Authorization：授权信息，通常出现在对服务器发送的WWW-Authenticate头的应答中。
- Connection：表示是否需要持久连接。如果Servlet看到这里的值为“Keep-Alive”，或者 看到请求使用的是HTTP 1.1（HTTP 1.1默认进行持久连接），它就可以利用持久连接的 优点，当页面包含多个元素时（例如Applet，图片），显著地减少下载所需要的时间。 要实现这一点，Servlet需要在应答中发送一个Content-Length头，最简单的实现方法是： 先把内容写入ByteArrayOutputStream，然后在正式写出内容之前计算它的大小。
- Content-Length：表示请求消息正文的长度。
- Cookie：这是最重要的请求头信息之一
- From：请求发送者的email地址，由一些特殊的Web客户程序使用，浏览器不会用到 它。 - Host：初始URL中的主机和端口。
- If-Modified-Since：只有当所请求的内容在指定的日期之后又经过修改才返回它，否则 返回304“Not Modified”应答。
- Pragma：指定“no-cache”值表示服务器必须返回一个刷新后的文档，即使它是代理服 务器而且已经有了页面的本地拷贝。
- Referer：包含一个URL，用户从该URL代表的页面出发访问当前请求的页面。
- User-Agent：浏览器类型，如果Servlet返回的内容与浏览器类型有关则该值非常有用。



2）**请求正文** 常用json格式



3）HTTP**响应报文**也是由三部分组成: 状态码, 响应报头和响应报文。

状态码



![img](http://pcc.huitogo.club/4270d0b998601a7636db8d2021bf3767)



常见的响应报头字段有: Server, Connection...。

响应报文是服务器返回给浏览器的文本信息，通常HTML, CSS, JS, 图片等文件就放在这一部分。



#### 4. 浏览器渲染页面

浏览器在收到HTML,CSS,JS文件后，它是如何把页面呈现到屏幕上的？

![img](http://pcc.huitogo.club/5eeeff61ea12378a13eb11fa0354d70c)



浏览器是一个边解析边渲染的过程。首先浏览器解析HTML文件构建DOM树，然后解析CSS文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。这个过程比较复杂，涉及到两个概念: reflow(回流)和repain(重绘)。DOM节点中的各个元素都是以盒模型的形式存在，这些都需要浏览器去计算其位置和大小等，这个过程称为relow;当盒模型的位置,大小以及其他属性，如颜色,字体,等确定下来之后，浏览器便开始绘制内容，这个过程称为repain。**页面在首次加载时必然会经历reflow和repain**。reflow和repain过程是非常消耗性能的，尤其是在移动设备上，它会破坏用户体验，有时会造成页面卡顿。所以我们应该**尽可能减少reflow和repain**。



关于js解析

![img](http://pcc.huitogo.club/d6d7383a3e6622b651c6192890f65e00)



JS的解析是由浏览器中的JS解析引擎完成的。**JS是单线程运行**，也就是说，在同一个时间内只能做一件事，所有的任务都需要排队，前一个任务结束，后一个任务才能开始。但是又存在某些任务比较耗时，如IO读写等，所以需要一种机制可以先执行排在后面的任务，这就是：同步任务(synchronous)和异步任务(asynchronous)。JS的执行机制就可以看做是一个主线程加上一个任务队列(task queue)。同步任务就是放在主线程上执行的任务，异步任务是放在任务队列中的任务。所有的同步任务在主线程上执行，形成一个执行栈;异步任务有了运行结果就会在任务队列中放置一个事件；脚本运行时先依次运行执行栈，然后会从任务队列里提取事件，运行任务队列中的任务，这个过程是不断重复的，所以又叫做事件循环(Event loop)。



浏览器在解析过程中，如果遇到请求外部资源时，如图像,iconfont,JS等。浏览器将重复1-6过程下载该资源。请求过程是异步的，并不会影响HTML文档进行加载，但是**当文档加载过程中遇到JS文件，HTML文档会挂起渲染过程**，不仅要等到文档中JS文件加载完毕还要等待解析执行完毕，才会继续HTML的渲染过程。原因是因为**JS有可能修改DOM结构**，这就意味着JS执行完成前，后续所有资源的下载是没有必要的，这就是JS阻塞后续资源下载的根本原因。CSS文件的加载不影响JS文件的加载，但是却影响JS文件的执行。**JS代码执行前浏览器必须保证CSS文件已经下载并加载完毕**。



#### 5. 总结

这里主要谈一些web的优化工作



在谈到Web优化之前，我们回到一个更原始的问题，Web前端的本质是什么。我的理解是: 将信息快速并友好的展示给用户并能够与用户进行交互。快速的意思就是在尽可能短的时间内完成页面的加载，试想一下当你在淘宝购买东西的时候，淘宝页面加载了10几秒才显示出物品，这个时候你还有心情去购买吗？怎么快速的完成页面的加载呢？



如何尽快的加载资源？答案就是能不从网络中加载的资源就不从网络中加载，当我们合理使用缓存，将资源放在浏览器端，这是最快的方式。如果资源必须从网络中加载，则要考虑缩短连接时间，即DNS优化部分;减少响应内容大小，即对内容进行压缩。另一方面，如果加载的资源数比较少的话，也可以快速的响应用户。当资源到达浏览器之后，浏览器开始进行解析渲染，浏览器中最耗时的部分就是reflow，所以围绕这一部分就是考虑如何减少reflow的次数。



关于web优化配合优雅的学院派雅虎给出了常用的一些手段，也就是我们熟悉的[雅虎34条军规](https://developer.yahoo.com/)。这34军规实际上就是围绕请求过程进行的一些优化方式。