Nacos服务注册表结构：Map<namespace, Map<group::serviceName, Service>>

![img](http://pcc.huitogo.club/9479eb688d234d6306add441c41b00cb)



举例说明

![img](http://pcc.huitogo.club/5bcdbeb6a6bc8661d9dbac6b5b0a3e5a)



其中有几个概念：



#### 1. Service

在服务发现领域中，服务指的是由应用程序提供的⼀个或⼀组软件功能的⼀种抽象概念（例如登录服务 和 支付服务）。|

![img](http://pcc.huitogo.club/e4a46dbe1e0f4bfab79c3327bfd3789e)



在 Nacos 中，服务的定义包括以下几个内容

- Namespace（命名空间）：Nacos 数据模型中最顶层、也是包含范围最广的概念，用于在类似 环境或租户等需要强制隔离的场景中定义。
- Group（分组）：Nacos 数据模型中次于命名空间的⼀种隔离概念，区别于命名空间的强制隔离 属性，分组属于⼀个弱隔离概念。
- Name（服务名）：服务实际的名字，⼀般用于描述该服务提供了某种功能或能力。

除了服务之间区别的字段之外，还有服务元数据；服务的定义只是为服务设置了⼀些基本的信息，用于描述服务以及方便快速的找到服务，而服务的 元数据是进⼀步定义了 Nacos 中服务的细节属性和描述信息。主要包含：

- ProtectThreshold（健康保护阈值）：为了防止因过多实例故障，导致所有流量全部流入剩余实 例，继而造成流量压力将剩余实例被压垮形成的雪崩效应。应将健康保护阈值定义为⼀个 0 到 1 之间的浮点数。当域名健康实例数占总服务实例数的比例小于该值时，无论实例是否健康，都会 将这个实例返回给客户端。这样做虽然损失了⼀部分流量，但是保证了集群中剩余健康实例能正常工作。
- Selector（实例选择器）：用于在获取服务下的实例列表时，过滤和筛选实例。该选择器也被称 为路由器，目前 Nacos 支持通过将实例的部分信息存储在外部元数据管理 CMDB 中，并在发现 服务时使用 CMDB 中存储的元数据标签来进行筛选的能力。
- extendData（拓展数据）：用于用户在注册实例时自定义扩展的元数服务中拓展服务的元数据信息，方便用户实现自己的自定义逻辑。



#### 2. Instance

服务实例是某个服务的具体提供能力的节点，⼀个实例仅从属于⼀个服务，而 ⼀个服务可以包含⼀个或多个实例。

![img](http://pcc.huitogo.club/dab377eb6fb9a1372aa1a721fe044366)



由于服务实例是具体提供服务的节点，因此 Nacos 在设计实例的定义时，主要需要存储该实例的 ⼀些网络相关的基础信息，主要包含以下内容：

- 网络 IP 地址：该实例的 IP 地址，在 Nacos2.0 版本后支持设置为域名。
- 网络端口：该实例的端口信息。
- 健康状态（Healthy）：用于表示该实例是否为健康状态，会在 Nacos 中通过健康检查的手段进 行维护，具体内容将在 Nacos 健康检查机制章节中详细说明，读者目前只需要该内容的含义即 可。
- 集群（Cluster）：用于标示该实例归属于哪个逻辑集群，有关于集群的相关内容，将在后文详细 说明。
- 拓展数据(extendData)：用于用户自定义扩展的元数据内容，形式为 K-V。可以在实例中拓展该 实例的元数据信息，方便用户实现自己的自定义逻辑和标示该实例。



和服务元数据不同，实例的元数据主要作用于实例运维相关的数据信息。主要包含：

- Weight（权重）：实例级别的配置。权重为浮点数，范围为 0-10000。权重越大，分配给该实例 的流量越大。
- Enabled（上线状态）：标记该实例是否接受流量，优先级大于权重和健康状态。用于运维人员 在不变动实例本身的情况下，快速地手动将某个实例从服务中移除。
- extendData（拓展数据）：不同于实例定义中的拓展数据，这个拓展数据是给予运维人员在不变动 实例本身的情况下，快速地修改和新增实例的扩展数据，从而达到运维实例的作用。



#### 3. Cluster

集群是 Nacos 中⼀组服务实例的⼀个逻辑抽象的概念，它介于服务和实例之间，是⼀部分服务属 性的下沉和实例属性的抽象。

![img](http://pcc.huitogo.club/f8918125ed938c7a94ad7bff4416662f)



在 Nacos 中，集群中主要保存了有关健康检查的⼀些信息和数据：

- 健康检查类型（HealthCheckType）：使用哪种类型的健康检查方式，MySQL；设置为 NONE 可以关闭健康检查。
- 健康检查端口（HealthCheckPort）：设置用于健康检查的端口。
- 是否使用实例端口进行健康检查（UseInstancePort）：如果使用实例使用实例定义中的网络端口进行健康检查，而不再使用上述设置的健康
- 拓展数据(extendData)：用于用户自定义扩展的元数据内容，形式为 K群的元数据信息，方便用户实现自己的自定义逻辑和标示该集群。